---
title: "5. Exponential Smoothing"
output: html_document
date: "2023-05-11"
---

In this section, we will focus on the analysis and forecasting of Crude oil and Natural gas exports, as we have decided not to consider petroleum products time series for our analysis. The exclusion of petroleum products was discussed earlier, and now we will explore the time series for natural gas and crude oil after applying the Box-Cox transformation.

Furthermore, our analysis will specifically concentrate on the application of exponential smoothing and ETS (Error, Trend, Seasonality) models. These models are widely used in time series forecasting and provide valuable insights into the underlying patterns and trends of the data.

5.1 Considering best ETS model

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Compute lambda using guerrero method for Crude Oil
lambda1 <- total_exp_oecd %>% 
  filter(`Export Type` == "Amount of Crude Oil (Thousand Barrels)") %>% 
  index_by(Date) %>% 
  summarise(Total_Exports = sum(`Amount`)) %>% 
  features(Total_Exports, features = guerrero) %>% 
  pull(lambda_guerrero)


# Apply Box-Cox transformation
crude_oil_agg <- total_exp_oecd %>% filter(year(Date) >= 2016) %>% 
  filter(`Export Type` == "Amount of Crude Oil (Thousand Barrels)") %>% 
  index_by(Date) %>% 
  summarise(Total_Exports = sum(`Amount`)) %>% 
  mutate(Total_Exports = box_cox(Total_Exports, lambda = lambda1))

# Compute lambda using guerrero method for Natural gas
lambda3 <- total_exp_oecd %>% 
  filter(`Export Type` == "Amount of Natural gas (BOE)") %>% 
  index_by(Date) %>% 
  summarise(Total_Exports = sum(`Amount`)) %>% 
  features(Total_Exports, features = guerrero) %>% 
  pull(lambda_guerrero)

# Apply Box-Cox transformation
nat_gas_agg <- total_exp_oecd %>% filter(year(Date) >= 2016) %>% 
  filter(`Export Type` == "Amount of Natural gas (BOE)") %>% 
  index_by(Date) %>% 
  summarise(Total_Exports = sum(`Amount`)) %>% 
  mutate(Total_Exports = box_cox(Total_Exports, lambda = lambda3))



# Combine the transformed time series
combined_data <- merge(crude_oil_agg, nat_gas_agg, by = "Date", all = TRUE)
#plotting time series

#Determining the ETS Model for Crude OIL
ggplot(combined_data, aes(x = Date)) +
  geom_line(aes(y = Total_Exports.x, color = "Crude Oil")) +
  geom_line(aes(y = Total_Exports.y, color = "Natural Gas")) +
  ylab("Amount (Transformed)") +
  ggtitle("Crude Oil and Natural Gas Exports") +
  scale_color_manual(values = c("Crude Oil" = "red", "Natural Gas" = "green"))


```

The graph above displays the time series for natural gas and crude oil exports after applying the Box-Cox transformation. Upon examination, we can observe that the time series for crude oil exhibits a higher level of consistency compared to natural gas. This consistency suggests that the crude oil time series may provide more reliable and relevant insights for our analysis.

It is worth mentioning that our analysis aims to investigate the changing reliance of OECD countries on Russian crude oil following the commencement of the conflict in Ukraine. Therefore, going forward, we will focus solely on the crude oil time series as it aligns more closely with the specific objectives of our analysis.

Within this section, we will explore various techniques and methodologies, such as time series decomposition, selection of appropriate forecasting methods, and evaluation of forecast accuracy. The application of exponential smoothing and ETS models will enable us to gain a deeper understanding of the patterns and dynamics within the crude oil time series.

```{r cars}
#determining best ETS model
fit<-crude_oil_agg %>% 
  model(
    additive=ETS(Total_Exports~error("A")+trend("A")+season("A")),
    multiplicative = ETS(Total_Exports ~ error("M") + trend("M") + season("M")),
    random1 = ETS(Total_Exports ~ error("M") + trend("A") + season("A")),
  )

#checking accuracy
accuracy(fit) 

addi_FC %>% 
  autoplot(
    crude_oil_agg) +
  labs(
    y = "Thousand Barrels",
    title = "Forecasts for U.S. Crude oil exports to OECD Europe") +
  guides(colour = guide_legend(title = "Forecast"))
```


After carefully examining the graph of the crude oil time series, which displayed a clear positive trend and some seasonality components, we needed to determine the most suitable ETS model. To do so, we adopted a systematic approach by creating multiple ETS models and comparing their accuracy.

We developed three ETS models: additive (ETS=AAA), multiplicative (ETS=MMM), and random1 (ETS=MAA). These models incorporate different combinations of error, trend, and seasonality components to capture various patterns and dynamics within the data.
After comparing the forecasting accuracy of the three ETS models (additive, multiplicative, and random), we observed that the additive model (ETS=AAA) outperformed the others in several metrics.

For the training dataset, the additive model had a lower RMSE (Root Mean Squared Error) of 4.51 compared to 5.12 for the multiplicative model and 4.78 for the random model. The MAE (Mean Absolute Error) was also lower for the additive model (3.52) compared to the multiplicative model (3.99) and random model (3.65).

Additionally, the additive model had a lower MAPE (Mean Absolute Percentage Error) of 7.37% compared to 8.32% for the multiplicative model. The MASE (Mean Absolute Scaled Error) value for the additive model (0.415) was lower than that of the multiplicative model (0.470), indicating better forecasting accuracy.

Considering these metrics, the additive model demonstrated superior performance in terms of forecasting accuracy for the natural gas time series. Hence, we selected the additive model (ETS=AAA) as the most appropriate ETS model for our analysis.

5.2 Applying ETS() function

```{applying ETS formula}
#ETS model selection by R
crude_fit <- crude_oil_agg %>%
  model(auto_crude_ets = ETS(Total_Exports))
#checking the accuracy
report(crude_fit)
# Print the selected ETS model
print(crude_fit$auto_crude_ets)
auto_crud%>% 
  autoplot(
    crude_oil_agg) +
  labs(
    y = "Thousand Barrels",
    title = "Forecasts for U.S. Crude oil exports to OECD Europe") +
  guides(colour = guide_legend(title = "Forecast"))

```

After applying the ETS() function to choose an appropriate model for the crude oil time series, we obtained the selected ETS model as <ETS(A,Ad,N)>. To assess the accuracy of the selected model, we calculated various metrics using the accuracy() function. The results indicate that the chosen model performs reasonably well in terms of forecasting accuracy. The ME (Mean Error) is close to zero, indicating that, on average, the model's forecasts are unbiased. The RMSE (Root Mean Squared Error) is 4.70, which represents the average magnitude of the forecast errors. The MAE (Mean Absolute Error) is 3.64, which measures the average absolute difference between the model's forecasts and the actual values. The MPE (Mean Percentage Error) is -1.33%, indicating a slight underestimation of the crude oil exports. The MAPE (Mean Absolute Percentage Error) is 7.87%, providing a measure of the relative forecasting accuracy. The MASE (Mean Absolute Scaled Error) is 0.430, suggesting that the model's forecasts outperform a naive seasonal method. The RMSSE (Root Mean Squared Scaled Error) is 0.464, which compares the model's performance to that of a na√Øve random walk model. Finally, the ACF1 (Autocorrelation of Forecast Errors) is 0.183, representing the correlation between successive forecast errors. Overall, the selected ETS model demonstrates satisfactory accuracy, aligning with the main features observed in the crude oil time series.

When comparing the two models, one which was selected by us and another by ETS() function, we can see that they do not coincide.
The additive model (ETS(A,A,A)) selected based on main features has certain parameters and characteristics, such as smoothing parameters and initial states. Its information criteria values (AIC, AICc, and BIC) are higher compared to the auto_crude_ets model.

In contrast, the auto_crude_ets model (ETS(A,Ad,N)) chosen through information criteria has different parameters and characteristics, including smoothing parameters and initial states. Its information criteria values are lower than those of the additive model.

This indicates that the two approaches resulted in different model selections. The main features approach emphasizes the structure of the data, while the information criteria approach prioritizes model simplicity and goodness-of-fit. Therefore, the models chosen based on main features and information criteria do not align in this case.


5.3 Checking the resuduals

```{bash}
#Plotting Residual
gg_tsresiduals(add)
gg_tsresiduals(crude_fit)
```

In context of white noise, in the case of the additive model and crude_fit, the significant values at lag 9 and lag 17 respectively suggest that there is some correlation or pattern present in the residuals at those specific lags.

Therefore, based on the ACF plot, it can be concluded that the residuals in both models do not exhibit the characteristics of white noise. The presence of significant values in the ACF plot indicates some level of autocorrelation or dependency between the residuals at certain lags, suggesting that there are systematic patterns or information that the models have not fully captured.