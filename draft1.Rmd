---
title: "FM project"
output: html_document
date: "2023-04-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Analysing U.S. energy exports


### 1.Introduction 

Energy commodities play a pivotal role in the global economy, as they are essential for economic growth and development. They are required for transportation, manufacturing, heating, cooling, and many other critical activities that drive economic activity. 

The production, consumption, and trade of energy commodities have significant impacts on the global economy. The prices of energy commodities are influenced by supply and demand factors, geopolitical tensions, weather events, and technological advances.

The recent COVID-19 pandemic and the war in Ukraine have created unprecedented changes in the energy market, and understanding the impact of these events is crucial for policymakers, analysts, and investors. This study aims to examine how the Russian war on Ukraine affected energy exports of the United States to the OECD Europe countries. 

OECD Europe was selected as the region, as because of geographical and historical relations it was most influenced region by the Russian war on Ukraine. The United States has been chosen as the focus because it is one of the leading producers and exporters of energy commodities, and its export trends have significant implications for the global energy market. Moreover, the United States serves as a significant alternative for OECD Europe countries to turn to after the imposition of sanctions on Russia.

In this study, we will analyze the impact of the war in Ukraine on US energy exports to OECD Europe. Specifically, we will focus on three main energy products: crude oil, petroleum products, and natural gas. By examining trends in these exports, we can better understand how the geopolitical events in Ukraine have affected the energy market in Europe. Additionally, we will investigate changes in OECD Europe's dependence on Russian gas to see how energy dynamics in the region have shifted. 




### 2. Time Series Graphics

In this section of the report, we will be creating time series graphics using various techniques such as time plots, seasonal plots, seasonal subseries plots, and ACF(). These plots will provide insights into the different time series in the dataset and help us understand their characteristics, such as seasonality, trend, and cyclicity. We will also look for unusual observations and changing patterns over time and explore the differences between the series in terms of these features. Additionally, for this analysis, we have decided to focus on three specific time series: US exports of Natural Gas to OECD, US Exports of Crude Oil to OECD, and US exports of Petroleum products to OECD. We will create the same types of graphs for all of these time series, including time plots, seasonal plots, seasonal subseries plots, and ACF plots. These time series span the last ten years from 2013 to 2023. Through these analyses, we aim to gain insights into the seasonality, cyclicity, trend, unusual observations, changing patterns, and differences between these time series, and determine if any of the series resemble a white noise process. By analyzing these time series graphics, we can gain a better understanding of the data and identify any potential patterns or anomalies that may exist within it.



### 2.1 Dataset


The data sets utilized in this study consist of monthly observations of Country’s reliance on Russian oil products, USA’s natural gas exports by country, USA’s total crude oil exports by destination, and USA’s petroleum products exports by destination.


Our primary source of data is the U.S. Energy Information Administration (EIA), an independent organization that collects, analyzes, and disseminates data and information related to energy production, consumption, and distribution in the United States. Also, for the purpose of this study we are using data from the International Energy Agency (IEA), which  is an intergovernmental organization that was established in 1974 to promote global cooperation on energy issues. 

In case of data on reliance on Russian Oil the dataset contains monthly total oil imports from Russia as a percentage of total oil imports for a selected group of European countries belonging to the Organization for Economic Co-operation and Development (OECD) from January 1990 to October 2022. The dataset includes the date, country name, and the percentage of total oil imports that came from Russia for each observation. 

In this section, we will analyze three datasets that pertain to US exports of Crude oil, Petroleum Products, and Natural Gas, all measured in barrels. Prior to converting the data to tsibble format, we performed data cleaning and formatting. To simplify the data, we converted each dataset to have the same structure, with three columns: date, destination country, and the amount exported. After standardizing the format, we converted each dataset to tsibble format. We then filtered the data to only include countries that are part of the OECD and summarized the results based on the amount exported on each date, removing country names and leaving only the date and amount exported. Finally, we merged all three tsibble tables into one by using the left join function and pivoting the data, resulting in a final time series that represents US exports of the three different products in barrels to OECD countries. The tsibble contains three columns: Date, Export Type, and Amount.

```{r, data_prep, echo=FALSE, results='markup',warning=FALSE,message=FALSE}
library(fpp3)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)

#Total Crude Oil Exports by Destination


raw_crude_oil <- read_csv("https://raw.githubusercontent.com/edb-313/Energy-trade-forecasting/main/Data/csv/Total%20Crude%20Oil%20Exports%20by%20Destination_EIA.csv", skip = 2,)


#Leaving only country names in column names

names(raw_crude_oil)[-2] <- str_replace_all(names(raw_crude_oil)[-2],
                                            c("U.S. Exports to " = "",
                                              " of Crude Oil \\(Thousand Barrels\\)" = ""))

#Pivoting (switching) columns starting from 2 column to rows

crude_oil <- raw_crude_oil %>% 
  pivot_longer(cols = -Date,
               names_to = 'Destination country',
               values_to = 'Amount of Crude Oil (Thousand Barrels)')



#Filtering out values where Date is 'NA'

crude_oil <- crude_oil %>%
  drop_na(Date) %>%
  mutate(Date = as.Date(Date))

#Fixing date format, replacing 'na' values with 0

crude_oil$Date <- as.Date(crude_oil$Date)
crude_oil$`Amount of Crude Oil (Thousand Barrels)` <- replace_na(crude_oil$`Amount of Crude Oil (Thousand Barrels)`, 0)

#Setting up the tsibble

ts_crude_oil <- crude_oil %>%
  mutate(Date = yearmonth(Date)) %>% 
  as_tsibble(
    index = Date, 
    key = `Destination country`
  )



#OECD Europe Countries vector

oecd_europe <- c("Austria", "Belgium", "Czech Republic", "Denmark", "Estonia",
                 "Finland", "France", "Germany", "Greece", "Hungary", "Iceland",
                 "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg",
                 "Netherlands", "Norway", "Poland", "Portugal", "Slovak Republic",
                 "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey",
                 "United Kingdom")

#filtering out only relevant values

oecd_crude_oil <- ts_crude_oil %>%
  filter(`Destination country` %in% oecd_europe) %>% 
  filter(Date >= as.Date("2010-01-15"), Date <= as.Date("2023-01-15")) 

oecd_crude_oil_agg <- oecd_crude_oil %>%
  index_by(Date) %>%
  summarize_at(vars(`Amount of Crude Oil (Thousand Barrels)`), sum) %>%
  ungroup()


################################################################################

#Total Oil Products Exports by Destination

raw_oil_prod <- read_csv("https://raw.githubusercontent.com/edb-313/Energy-trade-forecasting/main/Data/csv/Total%20Oil%20Products%20Exports%20by%20Destination_EIA.csv",  skip = 2,)

names(raw_oil_prod)[-2] <- str_replace_all(names(raw_oil_prod)[-2],
                                           c("U.S. Exports to " = "",
                                             " of Total Petroleum Products \\(Thousand Barrels\\)" = ""))
oil_prod <- raw_oil_prod %>% 
  pivot_longer(cols = -Date,
               names_to = 'Destination country',
               values_to = 'Amount of total Petroleum Porducts (Thousand Barrels)')


oil_prod$`Amount of total Petroleum Porducts (Thousand Barrels)` <- replace_na(oil_prod$`Amount of total Petroleum Porducts (Thousand Barrels)`, 0)

oil_prod <- oil_prod %>% 
  drop_na(Date) %>% 
  mutate(Date = as.Date(Date))

ts_oil_prod <- oil_prod %>%
  mutate(Date = yearmonth(Date)) %>% 
  as_tsibble(
    index = Date, 
    key = `Destination country`
  )

oecd_oil_prod <- ts_oil_prod %>% 
  filter(`Destination country` %in% oecd_europe) %>% 
  filter(Date >= as.Date("2010-01-15"), Date <= as.Date("2023-01-15"))


oecd_oil_prod_agg <- oecd_oil_prod %>%
  index_by(Date) %>%
  summarize_at(vars(`Amount of total Petroleum Porducts (Thousand Barrels)`), sum) %>%
  ungroup()

################################################################################
#Reliance on Russian gas

raw_rel_rusoil <- read_csv("https://raw.githubusercontent.com/edb-313/Energy-trade-forecasting/main/Data/csv/Monthly_Reliance_on_Russian_Oil.csv", skip = 1)

rel_rusoil <- raw_rel_rusoil %>% 
  pivot_longer(cols = -...1,
               names_to = 'Date',
               values_to = 'Total Oil Imports from Russia / Total Oil Imports (%)')

rel_rusoil <- rel_rusoil %>% 
  rename(Country = ...1) %>% 
  mutate(Date = lubridate::dmy(Date)) %>% 
  select("Date","Country","Total Oil Imports from Russia / Total Oil Imports (%)")


ts_rel_rusoil <- rel_rusoil %>% 
  as_tsibble(
    index = Date,
    key = Country)

oecd_relrus <- ts_rel_rusoil %>%
  filter(Country %in% oecd_europe)

################################################################################
#Total Natural Gas Exports by Destination

raw_nat_gas <- read.csv('https://raw.githubusercontent.com/edb-313/Energy-trade-forecasting/main/Data/csv/Natural%20Gas%20Exports%20by%20Country_EIA.csv',header=TRUE , check.names=FALSE, skip = 2)

# drop columns 2-3, 6-8, 54 and 57-72
raw_nat_gas <- subset(raw_nat_gas, select = -c(2:3, 6:8,54, 57:72))
raw_nat_gas[is.na(raw_nat_gas)] <- 0

#cimbining exports to the same countries

nat_gas <- raw_nat_gas %>%
  mutate(Mexico = `U.S. Natural Gas Pipeline Exports to Mexico (MMcf)` + `Liquefied U.S. Natural Gas Exports by Truck to Mexico (Million Cubic Feet)`,
         Canada = `U.S. Natural Gas Pipeline Exports to Canada (MMcf)` + `Liquefied U.S. Natural Gas Exports by Truck to Canada (Million Cubic Feet)`)

#removing duplicate columns

nat_gas <- nat_gas[, !(names(nat_gas) %in% c('U.S. Natural Gas Pipeline Exports to Mexico (MMcf)',
                                             'Liquefied U.S. Natural Gas Exports by Truck to Mexico (Million Cubic Feet)',
                                             'U.S. Natural Gas Pipeline Exports to Canada (MMcf)',
                                             'Liquefied U.S. Natural Gas Exports by Truck to Canada (Million Cubic Feet)'))]

#cleaning column names

colnames(nat_gas) <- gsub(pattern = ".*(to\\s)", "", colnames(nat_gas))
colnames(nat_gas) <- gsub("\\(.*?\\)", "", colnames(nat_gas))

#pivoting data
gastemp <- nat_gas %>% 
  pivot_longer(cols = -Date,
               names_to = 'Destination country',
               values_to = 'Amount of Natural gas (MMcf)')

#removing n/as in date column, fixing date formatting, fixing values (romoving space in the end)
library(stringr) #for triming the strings

gastemp <- gastemp %>% 
  drop_na(Date) %>% 
  mutate(Date = as.Date(Date)) %>% 
  mutate(`Destination country` = str_trim(`Destination country`))


#summing duplicates 

gastemp <- gastemp %>%
  group_by(Date, `Destination country`) %>%
  summarize_at(vars(`Amount of Natural gas (MMcf)`), sum) %>%
  ungroup() %>% 
  drop_na(Date)

#creating a tsibble

ts_nat_gas <- gastemp %>%
  mutate(Date = yearmonth(Date)) %>% 
  as_tsibble(
    index = Date,
    key = `Destination country`
  )

#filtering only relevant data

oecd_nat_gas <- ts_nat_gas %>%
  filter(`Destination country` %in% oecd_europe) %>% 
  filter(Date >= as.Date("2010-01-15"), Date <= as.Date("2023-01-15"))

oecd_nat_gas_agg <- oecd_nat_gas %>%
  index_by(Date) %>%
  summarize_at(vars(`Amount of Natural gas (MMcf)`), sum) %>%
  ungroup()

oecd_nat_gas_agg <- oecd_nat_gas_agg %>% 
  mutate(`Amount of Natural gas (BOE)` = `Amount of Natural gas (MMcf)` * 1000 / 6000 )

oecd_nat_gas_agg <- oecd_nat_gas_agg %>% 
  select(Date, `Amount of Natural gas (BOE)`)

################################################################################

oecd_merged <- left_join(oecd_nat_gas_agg, oecd_oil_prod_agg, by = "Date") %>%
  left_join(oecd_crude_oil_agg, by = "Date")

total_exp_oecd <- oecd_merged %>%
  pivot_longer(cols = -Date, names_to = "Export Type", values_to = "Amount")


total_exp_oecd %>% ggplot(
 aes(Date,Amount,color = `Export Type`)) +
   geom_line()+
   labs(x = "Date", y = "Amount")+
  theme(legend.position = "bottom")


```



### 3. Time series decomposition



#### 3.1. Adjustments


After a thorough review of the data, we determined that no adjustments were necessary. We did not observe any calendar or population effects on the monthly exports data, and the exports data is already presented in barrels or barrels of oil equivalent (BOE), so no inflation adjustments were required.



#### 3.2. Transformations


Given the nature of the three data sets that are being used: Crude Oil Exports, Petroleum exports and Natural gas exports we decided that certain transformations might be necessary. Not normal distribution of the data and differing variance were seen as potential threat for correct conclusions. We identified Box-Cox transformation as necessary to continue since it stabilizes the variance of the data and makes the distribution more normal. This will  improve the reliability of the statistical tests and provide more accurate results. 

For Box-Cox transformation to be performed we found lambda for each time series and than use it to transform the time series. 


```{r, box_cox, echo=TRUE, results='markup',warning=FALSE,message=FALSE}

lambda1 <- oecd_crude_oil_agg %>% 
  features(`Amount of Crude Oil (Thousand Barrels)`, features = guerrero) %>% 
  pull(lambda_guerrero)
crude_oil_agg <- oecd_crude_oil_agg %>% 
  mutate(`Amount of Crude Oil (Thousand Barrels)` = box_cox(`Amount of Crude Oil (Thousand Barrels)`, lambda1))

lambda2 <- oecd_oil_prod_agg %>% 
  features(`Amount of total Petroleum Porducts (Thousand Barrels)`, features = guerrero) %>% 
  pull(lambda_guerrero)
oil_prod_agg <-oecd_oil_prod_agg %>% 
  mutate(`Amount of total Petroleum Porducts (Thousand Barrels)` = box_cox(`Amount of total Petroleum Porducts (Thousand Barrels)`, lambda2))

lambda3 <- oecd_nat_gas_agg %>% 
  features(`Amount of Natural gas (BOE)`, features = guerrero) %>% 
  pull(lambda_guerrero)
nat_gas_agg <- oecd_nat_gas_agg %>% 
  mutate(`Amount of Natural gas (BOE)` = box_cox(`Amount of Natural gas (BOE)`, lambda3))

```
  
  
  
  
#### 3.3. Decomposition


STL Decomposition

```{r, decomposition, echo=TRUE, results='markup',warning=FALSE,message=FALSE }

dcmp_oecd_crude_oil <- oecd_crude_oil_agg %>%
  model(stl = STL(`Amount of Crude Oil (Thousand Barrels)`))

components(dcmp_oecd_crude_oil)


dcmp_oecd_oil_prod <- oecd_oil_prod_agg %>%
  model(stl = STL(`Amount of total Petroleum Porducts (Thousand Barrels)`))

components(dcmp_oecd_oil_prod)


dcmp_oecd_nat_gas <- oecd_nat_gas_agg %>%
  model(stl = STL(`Amount of Natural gas (BOE)`))

components(dcmp_oecd_nat_gas)




```


```{r, decomposition_plots, echo=FALSE, results='markup',warning=FALSE,message=FALSE }

components(dcmp_oecd_crude_oil) %>% autoplot()

components(dcmp_oecd_oil_prod) %>% autoplot()

components(dcmp_oecd_nat_gas) %>% autoplot()
```




## 4. The forecaster’s toolbox

Almost done, needs bit more input

## 5. Exponential smoothing

Yet to be started

## 6. ARIMA

Yet to be started

## 7. Other forecasting methods

Yet to be started